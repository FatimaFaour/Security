services:
  target:
    image: nginx:1.27-alpine
    container_name: nsml_target
    networks:
      dmz:
        ipv4_address: 172.31.0.10
    volumes:
      - ./target/html:/usr/share/nginx/html:ro
      - ./data/target:/var/log/nginx

  client:
    build:
      context: ./client
    container_name: nsml_client
    networks:
      lan:
        ipv4_address: 172.30.0.10
    depends_on:
      - firewall
    volumes:
      - ./data/client:/var/log/client

  firewall:
    build:
      context: ./firewall
    container_name: nsml_firewall
    networks:
      lan:
        ipv4_address: 172.30.0.1
      dmz:
        ipv4_address: 172.31.0.1
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    volumes:
      - ./data/firewall:/var/log/firewall
    depends_on:
      - target

  snort:
    build:
      context: ./snort
    container_name: nsml_snort
    networks:
      dmz:
        ipv4_address: 172.31.0.20
    cap_add:
      - NET_ADMIN
      - NET_RAW
    command: ["snort", "-i", "eth0", "-c", "/etc/snort/snort.conf", "-A", "fast", "-l", "/var/log/snort"]
    volumes:
      - ./snort/snort.conf:/etc/snort/snort.conf:ro
      - ./snort/local.rules:/etc/snort/rules/local.rules:ro
      - ./data/snort:/var/log/snort
    depends_on:
      - firewall

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.2
    container_name: nsml_elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - observability
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=60s > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 12

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.2
    container_name: nsml_kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    networks:
      - observability
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5601/api/status > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 12

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.15.2
    container_name: nsml_filebeat
    user: root
    volumes:
      - ./observability/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./data/snort:/var/log/snort:ro
      - ./data/firewall:/var/log/firewall:ro
      - ./data/target:/var/log/nginx:ro
      - filebeat-data:/usr/share/filebeat/data
    networks:
      - observability
    depends_on:
      elasticsearch:
        condition: service_healthy
    command: ["filebeat", "-e", "-strict.perms=false"]
networks:
  lan:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
  dmz:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/24

  observability:
    driver: bridge

volumes:
  elasticsearch-data:
  filebeat-data:
